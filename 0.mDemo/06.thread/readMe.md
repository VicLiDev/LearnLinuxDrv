# `task_struct`ã€`kthread_worker`ã€`work_struct` å’Œ `delayed_work`

---

## ä¸€è§ˆï¼šå››è€…çš„å¯¹æ¯”

åœ¨ Linux å†…æ ¸ä¸­ï¼Œæœ‰å¤šç§æœºåˆ¶ç”¨äºå¼‚æ­¥ä»»åŠ¡å¤„ç†å’Œçº¿ç¨‹æ§åˆ¶ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§ç»“æ„åŠå…¶å·®å¼‚ï¼š

1. **`task_struct`**
   * **ç±»å‹**ï¼šæ•°æ®ç»“æ„
   * **æœºåˆ¶ç±»åˆ«**ï¼šçº¿ç¨‹/è¿›ç¨‹è°ƒåº¦ç³»ç»Ÿ
   * **ç”¨é€”**ï¼šè¡¨ç¤ºå†…æ ¸ä¸­æ¯ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹çš„æ ¸å¿ƒæè¿°ç¬¦ã€‚åŒ…å«è°ƒåº¦çŠ¶æ€ã€å†…å­˜ä¿¡æ¯ã€ä¿¡å·ã€
     CPU ç»‘å®šç­‰ã€‚
   * **æ˜¯å¦æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**ï¼šâœ… æ”¯æŒå®Œå…¨æ§åˆ¶ï¼ˆå¦‚åˆ›å»ºã€åœæ­¢ã€å”¤é†’ç­‰ï¼‰
   * **æ˜¯å¦æ”¯æŒå»¶è¿Ÿæ‰§è¡Œ**ï¼šâŒ ä¸æ”¯æŒå»¶è¿Ÿè°ƒåº¦é€»è¾‘ï¼ˆéœ€é…åˆå®šæ—¶å™¨ï¼‰
   * **è¿è¡Œä¸Šä¸‹æ–‡**ï¼šå†…æ ¸çº¿ç¨‹æˆ–è¿›ç¨‹ä¸Šä¸‹æ–‡
   * **å…¸å‹ç”¨æ³•**ï¼š`kthread_create()` åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€è®¿é—®å½“å‰çº¿ç¨‹ç”¨ `current`ï¼Œè°ƒè¯•æˆ–
     è°ƒåº¦æ“ä½œç­‰

2. **`kthread_worker`**
   * **ç±»å‹**ï¼šæ•°æ®ç»“æ„
   * **æœºåˆ¶ç±»åˆ«**ï¼šè‡ªå®šä¹‰çº¿ç¨‹å·¥ä½œé˜Ÿåˆ—
   * **ç”¨é€”**ï¼šè°ƒåº¦å¤šä¸ª `kthread_work` æˆ– `kthread_delayed_work`ï¼Œç”±ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è¿è¡Œï¼Œ
     é€‚ç”¨äºé©±åŠ¨ç­‰å¯¹çº¿ç¨‹æ§åˆ¶è¦æ±‚é«˜çš„åœºæ™¯ã€‚
   * **æ˜¯å¦æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**ï¼šâœ… å¯ä»¥æ§åˆ¶ï¼ˆç”±ä½ åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼‰
   * **æ˜¯å¦æ”¯æŒå»¶è¿Ÿæ‰§è¡Œ**ï¼šâœ… æ”¯æŒï¼ˆä½¿ç”¨ `kthread_delayed_work`ï¼‰
   * **è¿è¡Œä¸Šä¸‹æ–‡**ï¼šå†…æ ¸çº¿ç¨‹ä¸Šä¸‹æ–‡
   * **å…¸å‹ç”¨æ³•**ï¼šåˆå§‹åŒ–ä¸€ä¸ª `kthread_worker`ï¼Œç”¨ `kthread_run()` åˆ›å»ºçº¿ç¨‹æ‰§è¡Œ
     `kthread_worker_fn()`ï¼Œé€‚ç”¨äºé•¿æœŸè¿è¡Œçš„ worker çº¿ç¨‹åœºæ™¯

3. **`work_struct`**
   * **ç±»å‹**ï¼šæ•°æ®ç»“æ„
   * **æœºåˆ¶ç±»åˆ«**ï¼šå·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰
   * **ç”¨é€”**ï¼šæäº¤ä¸€ä¸ªå¼‚æ­¥å‡½æ•°åˆ°å†…æ ¸çš„ç³»ç»Ÿå·¥ä½œçº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œé€‚åˆçŸ­æ—¶ã€è½»é‡çš„ä»»åŠ¡ã€‚
   * **æ˜¯å¦æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**ï¼šâŒ ä¸æ”¯æŒï¼ˆçº¿ç¨‹ç”±å†…æ ¸ç»Ÿä¸€ç®¡ç†ï¼‰
   * **æ˜¯å¦æ”¯æŒå»¶è¿Ÿæ‰§è¡Œ**ï¼šâŒ ä¸æ”¯æŒï¼ˆä¸èƒ½ç›´æ¥å»¶è¿Ÿï¼Œéœ€è¦é…åˆ `delayed_work`ï¼‰
   * **è¿è¡Œä¸Šä¸‹æ–‡**ï¼šè½¯ä¸­æ–­ä¸Šä¸‹æ–‡æˆ–å·¥ä½œçº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆéä¸­æ–­ï¼‰
   * **å…¸å‹ç”¨æ³•**ï¼šä½¿ç”¨ `INIT_WORK()` åˆå§‹åŒ–ï¼Œè°ƒç”¨ `schedule_work()` æäº¤ä»»åŠ¡

4. **`delayed_work`**
   * **ç±»å‹**ï¼šç»“æ„ä½“å®ï¼ˆåŒ…å« `work_struct` + `timer_list`ï¼‰
   * **æœºåˆ¶ç±»åˆ«**ï¼šå»¶è¿Ÿå·¥ä½œé˜Ÿåˆ—
   * **ç”¨é€”**ï¼šåœ¨å»¶è¿Ÿä¸€æ®µæ—¶é—´åï¼Œå°†ä»»åŠ¡æäº¤ç»™ç³»ç»Ÿå·¥ä½œé˜Ÿåˆ—æ‰§è¡Œã€‚
   * **æ˜¯å¦æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**ï¼šâŒ ä¸æ”¯æŒï¼ˆä½¿ç”¨ç³»ç»Ÿçº¿ç¨‹æ± ï¼‰
   * **æ˜¯å¦æ”¯æŒå»¶è¿Ÿæ‰§è¡Œ**ï¼šâœ… æ”¯æŒï¼ˆé€šè¿‡å®šæ—¶å™¨æœºåˆ¶ï¼‰
   * **è¿è¡Œä¸Šä¸‹æ–‡**ï¼šåŒ `work_struct`ï¼Œè¿è¡Œåœ¨å·¥ä½œé˜Ÿåˆ—çº¿ç¨‹ä¸­
   * **å…¸å‹ç”¨æ³•**ï¼šä½¿ç”¨ `INIT_DELAYED_WORK()` åˆå§‹åŒ–ï¼Œè°ƒç”¨ `schedule_delayed_work()`
     è®¾ç½®å»¶è¿Ÿå¹¶æäº¤æ‰§è¡Œ

tops:
* `task_struct` æ˜¯çº¿ç¨‹çš„åŸºç¡€ï¼Œè´¯ç©¿æ‰€æœ‰æœºåˆ¶ã€‚
* `work_struct` å’Œ `delayed_work` æ˜¯ **â€œé¢å‘ä»»åŠ¡â€çš„é˜Ÿåˆ—æ‰§è¡Œæœºåˆ¶**ã€‚
* `kthread_worker` æ˜¯ **â€œé¢å‘çº¿ç¨‹â€çš„æ‰§è¡Œæœºåˆ¶** ï¼Œæ›´å¼ºå¤§ä½†ä¹Ÿéœ€è¦è‡ªå·±ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸã€‚

## kthread_worker/work_struct è¯¦ç»†å¯¹æ¯”

kthread_worker å’Œ work_struct æ²¡æœ‰åŒ…å«å…³ç³»ï¼Œå±äºå®Œå…¨**ä¸åŒçš„æœºåˆ¶ã€‚
å®ƒä»¬åˆ†åˆ«æœåŠ¡äºä¸¤ç§ä¸åŒçš„å·¥ä½œé˜Ÿåˆ—æ¨¡å‹ï¼š
| é¡¹ç›®             | `kthread_worker`                          | `work_struct`                        |
| ---------------- | ----------------------------------------- | ------------------------------------ |
| å·¥ä½œæ¨¡å‹         | è‡ªå»ºçº¿ç¨‹ â†’ æ‰§è¡Œå¤šä¸ªä»»åŠ¡                   | ç³»ç»Ÿå†…æ ¸çº¿ç¨‹æ±  â†’ æ‰§è¡Œä¸€ä¸ªä¸ªä»»åŠ¡      |
| ä»»æ„çº¿ç¨‹æ‰§è¡Œï¼Ÿ   | åªåœ¨ç»‘å®šçš„ `kthread_worker` çº¿ç¨‹æ‰§è¡Œ      | ä»»æ„ç”±å†…æ ¸è°ƒåº¦çš„ worker çº¿ç¨‹         |
| æ§åˆ¶åŠ›           | é«˜åº¦æ§åˆ¶çº¿ç¨‹è¡Œä¸º                          | æ— æ³•æ§åˆ¶å…·ä½“æ‰§è¡Œçº¿ç¨‹                 |
| æ˜¯å¦æœ‰åŒ…å«å…³ç³»ï¼Ÿ | æ— ä»»ä½•ç»“æ„ä½“å±‚çº§æˆ–åµŒå¥—å…³ç³»                | ä¸ `kthread_worker` å®Œå…¨æ— å…³         |
| çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ     | éœ€è¦è´Ÿè´£åˆ›å»ºã€åœæ­¢ `kthread_worker` çº¿ç¨‹  | å†…æ ¸ç®¡ç†çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸ               |
| æ¥å£è°ƒç”¨         | `kthread_queue_work()` ç­‰                 | `schedule_work()`ã€`flush_work()` ç­‰ |


ç±»æ¯”ç†è§£ï¼ˆæ‰“å·¥æ¨¡å‹ï¼‰ï¼š
| æ¦‚å¿µ             | ç±»æ¯”è§’è‰²                     | ç‰¹ç‚¹                       |
| ---------------- | ---------------------------- | -------------------------- |
| `work_struct`    | ç»™ç³»ç»Ÿä¸´æ—¶æ‰¾çš„æ‰“å·¥äºº         | äººæ˜¯è°ä¸é‡è¦ï¼Œåªè¦å¹²æ´»å°±è¡Œ |
| `kthread_worker` | è‡ªå·±é›‡çš„å‘˜å·¥å›¢é˜Ÿ             | å¿…é¡»åœ¨ä½ å®‰æ’çš„çº¿ç¨‹é‡Œå·¥ä½œ   |
| `kthread_work`   | åˆ†ç»™ `kthread_worker` çš„ä»»åŠ¡ | å®ƒä¸èƒ½æŠ•ç»™ `work_struct`   |



### å·¥ä½œé€»è¾‘å¯¹æ¯”

| ç‰¹æ€§              | `work_struct`ï¼ˆé€šç”¨å·¥ä½œé˜Ÿåˆ—ï¼‰                                            | `kthread_work`ï¼ˆå†…æ ¸çº¿ç¨‹å·¥ä½œé˜Ÿåˆ—ï¼‰                                     |
| ----------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------- |
| **æ ¸å¿ƒæ€æƒ³**      | æŠŠä»»åŠ¡æ”¾è¿›å†…æ ¸**å…¨å±€/è‡ªå®šä¹‰ workqueue**ï¼Œç”± worker çº¿ç¨‹æ± æ‰§è¡Œ            | æŠŠä»»åŠ¡æ”¾è¿›ä½ è‡ªå·±åˆ›å»ºçš„ **kthread_worker** é˜Ÿåˆ—ï¼Œç”±ä½ è‡ªå·±çš„å†…æ ¸çº¿ç¨‹æ‰§è¡Œ |
| **è°ƒåº¦ä¸»ä½“**      | ç³»ç»Ÿç»´æŠ¤çš„ **kworker** çº¿ç¨‹æ± ï¼ˆæ¯ CPU é€šå¸¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼‰               | ä½ åˆ›å»ºçš„ **kthread_worker**ï¼ˆé€šå¸¸å°±æ˜¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼‰                    |
| **åˆå§‹åŒ–**        | `INIT_WORK(&work, handler)`                                              | `kthread_init_work(&work, handler)`                                    |
| **æäº¤ä»»åŠ¡**      | `schedule_work(&work)`ï¼ˆé»˜è®¤é˜Ÿåˆ—ï¼‰æˆ– `queue_work(wq, &work)`ï¼ˆæŒ‡å®šé˜Ÿåˆ—ï¼‰ | `kthread_queue_work(worker, &work)`                                    |
| **ä»»åŠ¡å­˜å‚¨ä½ç½®**  | workqueue çš„é“¾è¡¨                                                         | kthread_worker çš„é“¾è¡¨                                                  |
| **æ‰§è¡Œçº¿ç¨‹æ•°é‡**  | é»˜è®¤æ˜¯å¤šçº¿ç¨‹ï¼ˆå¯èƒ½è·¨ CPU å¹¶è¡Œï¼‰                                          | ä¸€èˆ¬å•çº¿ç¨‹ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰                                                 |
| **çº¿ç¨‹æ§åˆ¶æƒ**    | å®Œå…¨ç”±å†…æ ¸è°ƒåº¦                                                           | ç”±ä½ å®Œå…¨æ§åˆ¶ï¼ˆå¯æš‚åœã€åœæ­¢ã€ç»‘å®š CPUï¼‰                                 |
| **CPU äº²å’Œæ€§**    | ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©ï¼ˆå¯èƒ½è·¨ CPUï¼‰                                               | ä½ å¯ä»¥ç»‘æ­»åˆ°æŒ‡å®š CPU                                                   |
| **ä½¿ç”¨åœºæ™¯**      | çŸ­å°å¼‚æ­¥ä»»åŠ¡ï¼Œä¸éœ€è¦ä¸¥æ ¼é¡ºåº                                             | é•¿è€—æ—¶ä»»åŠ¡ã€éœ€è¦ä¸²è¡Œé¡ºåºã€éœ€è¦ç²¾ç¡®çº¿ç¨‹æ§åˆ¶                             |

---

### å¹¶è¡Œæ€§å¯¹æ¯”

#### `work_struct`

* **é»˜è®¤ workqueue** â†’ å¤š worker çº¿ç¨‹ â†’ å¤š CPU ä¸Šå¯å¹¶è¡Œæ‰§è¡Œä¸åŒä»»åŠ¡
* åŒä¸€ä¸ª `struct work_struct` ä»»åŠ¡ï¼š
  * **ä¸èƒ½å¹¶è¡Œ**ï¼ˆå› ä¸ºå†…éƒ¨æœ‰ `pending` æ ‡å¿—ï¼‰
  * å¦‚æœä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œé‡å¤æäº¤ä¼šè¢«å¿½ç•¥
* ä¸åŒçš„ `struct work_struct` â†’ **å¯èƒ½åŒæ—¶è¿è¡Œåœ¨ä¸åŒ CPU**

---

#### `kthread_work`

* åŒä¸€ä¸ª `kthread_worker` **ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡** â†’ **ç»å¯¹ä¸²è¡Œ**
* å³ä½¿æäº¤å¤šä¸ªä»»åŠ¡ï¼Œä¹Ÿä¼šä¸€ä¸ªæ¥ä¸€ä¸ªæ‰§è¡Œ
* å¦‚æœè¦å¹¶è¡Œï¼Œéœ€è¦è‡ªå·±åˆ›å»ºå¤šä¸ª `kthread_worker`ï¼ˆå¤šä¸ªçº¿ç¨‹ï¼‰

---

### æ‰§è¡Œæµç¨‹å›¾

```
work_structï¼ˆå¤šçº¿ç¨‹æ¨¡å‹ï¼‰:
   schedule_work() â†’ åŠ å…¥ system_wq
                     â†“
            å¤šä¸ª kworker çº¿ç¨‹äº‰æŠ¢ä»»åŠ¡
             CPU0 æ‰§è¡Œä»»åŠ¡A   CPU1 æ‰§è¡Œä»»åŠ¡B   CPU2 æ‰§è¡Œä»»åŠ¡C
            ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰

kthread_workï¼ˆå•çº¿ç¨‹æ¨¡å‹ï¼‰:
   kthread_queue_work() â†’ åŠ å…¥ kthread_worker é˜Ÿåˆ—
                            â†“
             å”¯ä¸€çš„ worker çº¿ç¨‹é¡ºåºå–ä»»åŠ¡
              æ‰§è¡Œä»»åŠ¡A â†’ æ‰§è¡Œä»»åŠ¡B â†’ æ‰§è¡Œä»»åŠ¡C
            ï¼ˆä¸¥æ ¼ä¸²è¡Œï¼‰
```

---

### æ€»ç»“

* **æƒ³çœäº‹** â†’ ç”¨ `work_struct`ï¼Œç”±ç³»ç»Ÿçº¿ç¨‹æ± è‡ªåŠ¨å¹¶è¡Œè°ƒåº¦
* **æƒ³ä¿è¯é¡ºåº** / **é•¿è€—æ—¶ä»»åŠ¡** / **ç²¾ç¡®æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ** â†’ ç”¨ `kthread_work`
* **åŒä¸€ä¸ªä»»åŠ¡ç»“æ„ä½“**ï¼ˆæ— è®ºå“ªç§ï¼‰åœ¨æ‰§è¡Œä¸­ä¸ä¼šè¢«å¹¶è¡Œè¿è¡Œï¼Œä½†ä¸åŒä»»åŠ¡çš„å¹¶è¡Œæƒ…å†µå–å†³äºçº¿ç¨‹æ¨¡å‹


---

## 1. `struct task_struct`

> ğŸ”§ **å†…æ ¸ä¸­æ¯ä¸ªçº¿ç¨‹ï¼ˆåŒ…æ‹¬å†…æ ¸çº¿ç¨‹å’Œç”¨æˆ·è¿›ç¨‹ï¼‰çš„æè¿°ç¬¦**

* åŒ…å«è°ƒåº¦ä¿¡æ¯ã€å†…å­˜æ˜ å°„ã€çŠ¶æ€ç­‰ã€‚
* å†…æ ¸çº¿ç¨‹ä½¿ç”¨å®ƒé€šè¿‡ `kthread_create()` / `kthread_run()` åˆ›å»ºã€‚
* ç”¨æˆ·ç©ºé—´è¿›ç¨‹ä¹Ÿä½¿ç”¨å®ƒï¼Œæ˜¯ `current` å®è¿”å›çš„å†…å®¹ã€‚

```c
struct task_struct *t = current;
pr_info("Current task is: %s (pid: %d)", t->comm, t->pid);
```

* ä½¿ç”¨åœºæ™¯ï¼šè°ƒè¯•çº¿ç¨‹ã€è°ƒåº¦æ§åˆ¶ã€é˜»å¡å”¤é†’ã€è°ƒè¯•ç­‰ã€‚

---

## 2. `struct kthread_worker`

> ğŸ§µ **ä¸€ä¸ªä¸“é—¨å¤„ç† `kthread_work` çš„å·¥ä½œè€…çº¿ç¨‹è°ƒåº¦å™¨**

* ç”¨äºè°ƒåº¦å¤šä¸ª `kthread_work` å’Œ `kthread_delayed_work`ã€‚
* è‡ªå®šä¹‰çº¿ç¨‹æ§åˆ¶ï¼Œé€‚åˆé©±åŠ¨æˆ–æ¨¡å—å†…çš„å·¥ä½œæ± éœ€æ±‚ã€‚
* å¿…é¡»ç»“åˆä¸€ä¸ª `task_struct` æ¥è¿è¡Œï¼Œå¦‚ï¼š

```c
kthread_init_worker(&worker);
task_struct *thread = kthread_run(kthread_worker_fn, &worker, "my_worker");
```

* å¯ä»¥æ‰‹åŠ¨è°ƒåº¦ã€å»¶è¿Ÿã€å–æ¶ˆã€åŒæ­¥ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚

é€‚åˆå¯¹çº¿ç¨‹æ§åˆ¶æœ‰æ˜ç¡®éœ€æ±‚çš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼š
âœ” å®æ—¶é©±åŠ¨
âœ” å¤§é‡å¼‚æ­¥ä»»åŠ¡æ’é˜Ÿæ‰§è¡Œ
âœ” å¯å–æ¶ˆä»»åŠ¡æ¨¡å‹

---

## 3. `struct work_struct`

> âš™ï¸ **ä¸€ä¸ªå‡½æ•°åŒ…è£…å™¨ï¼Œç”¨äºæäº¤å¼‚æ­¥ä»»åŠ¡åˆ°ç³»ç»Ÿå·¥ä½œé˜Ÿåˆ—**

* é…åˆ `INIT_WORK()` å’Œ `schedule_work()` ä½¿ç”¨ã€‚
* é€‚åˆè½»é‡çº§ã€éå®æ—¶çš„å¼‚æ­¥å¤„ç†ã€‚
* ä¸ç»‘å®šç‰¹å®šçº¿ç¨‹ï¼Œç”±ç³»ç»Ÿå…¨å±€çº¿ç¨‹æ± è‡ªåŠ¨è°ƒåº¦ã€‚

ç¤ºä¾‹ï¼š

```c
INIT_WORK(&my_work, work_func);
schedule_work(&my_work);
```

* é€šå¸¸è¿è¡Œåœ¨ `kworker/*` ç³»ç»Ÿçº¿ç¨‹ä¸­ã€‚
* ä¸€èˆ¬ä¸ä¿è¯å®æ—¶æ€§ã€ä¸ä¿è¯é¡ºåºï¼Œä¸é€‚åˆå¤„ç†æ—¶åºæ•æ„Ÿæˆ–äº’æ–¥å¼ºçš„åœºæ™¯ã€‚

---

## 4. `struct delayed_work`

> â³ **å¸¦å®šæ—¶å™¨çš„å»¶è¿Ÿç‰ˆæœ¬ work_struct**

* å®è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ç»„åˆï¼š

```c
struct delayed_work {
    struct work_struct work;
    struct timer_list timer;
};
```

* ç”¨äºå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œé€‚åˆå®šæ—¶é‡è¯•ã€timeout handler ç­‰ã€‚

```c
INIT_DELAYED_WORK(&dw, work_func);
schedule_delayed_work(&dw, msecs_to_jiffies(1000)); // 1ç§’åæ‰§è¡Œ
```

* æ‰§è¡Œæ—¶æœºé å®šæ—¶å™¨è°ƒåº¦ï¼Œç„¶åè‡ªåŠ¨æäº¤åˆ°ç³»ç»Ÿå·¥ä½œé˜Ÿåˆ—ã€‚

---

## ä½¿ç”¨å»ºè®®å’Œå…¸å‹ç»„åˆ

| ç›®æ ‡                                   | å»ºè®®ç”¨æ³•                          | åŸå›                          |
| -------------------------------------- | --------------------------------- | ---------------------------- |
| éœ€è¦åˆ›å»ºä½ è‡ªå·±çš„çº¿ç¨‹ï¼Œå¹¶è°ƒåº¦å¤šä¸ªå·¥ä½œé¡¹ | `kthread_worker` + `kthread_work` | çµæ´»ã€é«˜æ€§èƒ½ã€å¯å–æ¶ˆã€å¯å¹¶è¡Œ |
| éœ€è¦ä¸€æ¬¡æ€§çš„å¼‚æ­¥æ‰§è¡Œå‡½æ•°               | `work_struct`                     | ç®€å•è½»é‡ï¼Œä¸éœ€ç®¡ç†çº¿ç¨‹       |
| éœ€è¦å»¶è¿Ÿä¸€æ®µæ—¶é—´åå¼‚æ­¥æ‰§è¡Œä»»åŠ¡         | `delayed_work`                    | ä½¿ç”¨å†…æ ¸å®šæ—¶å™¨è°ƒåº¦ä»»åŠ¡       |
| æ§åˆ¶çº¿ç¨‹è¡Œä¸ºï¼ˆç¡çœ ã€é˜»å¡ã€ä¿¡å·ï¼‰       | `task_struct`                     | çº¿ç¨‹æ§åˆ¶æ ¸å¿ƒç»“æ„             |


## kthread_worker è¯¦è§£

---

### ä»€ä¹ˆæ˜¯ `kthread_worker` æœºåˆ¶ï¼Ÿ

`kthread_worker` æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ä¸ª**åŸºäºå†…æ ¸çº¿ç¨‹çš„å¼‚æ­¥å·¥ä½œé˜Ÿåˆ—ç³»ç»Ÿ**ã€‚
å®ƒè·Ÿ `workqueue` ç±»ä¼¼ï¼Œä½†æ›´è½»é‡ã€ç§æœ‰ã€å®æ—¶æ€§æ›´å¯æ§ã€‚

å®ƒå†…éƒ¨é€šè¿‡ï¼š
* ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼ˆkthreadï¼‰
* ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼ˆFIFO é˜Ÿåˆ—ï¼‰
* ä¸æ–­ä»é˜Ÿåˆ—å–å‡ºä»»åŠ¡æ‰§è¡Œ

æ¥å®Œæˆå¼‚æ­¥ä»»åŠ¡å¤„ç†ã€‚

---

### æ ¸å¿ƒç»“æ„ä½“å’Œå‡½æ•°å…³ç³»å›¾

æŒ‰**ç»“æ„ä½“** å’Œ **å‡½æ•°** æ¥ç†æ¸…æ¥šè°è´Ÿè´£åšä»€ä¹ˆï¼š
```
è‡ªå®šä¹‰å·¥ä½œå‡½æ•°ï¼ˆvoid my_work_fn(struct kthread_work *work)ï¼‰
         â†‘
   æ‰§è¡Œå™¨ï¼š__kthread_run_work(worker, work)
         â†‘
å·¥ä½œçº¿ç¨‹ï¼škthread_worker_fn(worker)  <-- æ³¨æ„è¿™ä¸ªï¼ï¼
         â†‘
åˆ›å»ºå‡½æ•°ï¼škthread_create_worker()
         â†‘
å¯åŠ¨çº¿ç¨‹ï¼škthread_create() å†…éƒ¨è°ƒç”¨çš„çº¿ç¨‹ä¸»ä½“å°±æ˜¯ kthread_worker_fn
```

---

### ä¸»è¦ç»“æ„ä½“è§£æ

#### 1. `struct kthread_worker`

```c
struct kthread_worker {
    spinlock_t lock;
    struct list_head work_list;     // å­˜æ”¾ kthread_work
    struct task_struct *task;      // çº¿ç¨‹æœ¬ä½“ï¼ˆkthread_create() ç”Ÿæˆï¼‰
};
```

å®ƒå°±æ˜¯ä¸€ä¸ªæ•´ä½“å®¹å™¨ï¼ŒåŒ…å«äº†ï¼š
* ä¸€ä¸ªâ€œä»»åŠ¡é˜Ÿåˆ—â€
* ä¸€ä¸ªâ€œçº¿ç¨‹â€

---

#### 2. `struct kthread_work`

```c
struct kthread_work {
    struct list_head node;
    void (*func)(struct kthread_work *work);  // ä½ å†™çš„å·¥ä½œå‡½æ•°
    atomic_t flushing;
    ...
};
```

æäº¤ç»™ `kthread_worker` çš„æ¯ä¸€ä¸ªä»»åŠ¡å°±æ˜¯ä¸€ä¸ª `kthread_work` å¯¹è±¡ã€‚

---

### æ ¸å¿ƒå‡½æ•°è¯´æ˜

#### 1. `kthread_create_worker()`
```c
struct kthread_worker *kthread_create_worker(unsigned int flags, const char *namefmt, ...);
```
* åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª `kthread_worker`
* å†…éƒ¨è°ƒç”¨ `kthread_create(kthread_worker_fn, worker, namefmt)` å¯åŠ¨çº¿ç¨‹
* ä¼šè®¾ç½®å¥½ `worker->task` å­—æ®µ
* **æ ¸å¿ƒç‚¹**ï¼šè¿™ä¸ªå‡½æ•°æ˜¯ `kthread_worker_fn()` å”¯ä¸€çš„åˆæ³•ä½¿ç”¨å…¥å£

#### 2. `kthread_init_worker(struct kthread_worker *worker)`
* åˆå§‹åŒ–ä¸€ä¸ªå·²æœ‰çš„ worker ç»“æ„ä½“ï¼Œä½†ä¸å¯åŠ¨çº¿ç¨‹
* å½“å¸Œæœ›æƒ³è‡ªå·±æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸæ—¶ä½¿ç”¨

#### 3. `kthread_worker_fn(void *worker)`
* çº¿ç¨‹ä¸»å‡½æ•°ï¼ˆä¸è¦è‡ªå·±ç”¨ï¼ï¼‰
* ä¸æ–­ä» `worker->work_list` ä¸­æ‹‰å–ä»»åŠ¡æ‰§è¡Œ
* ä¼šè°ƒç”¨ `__kthread_run_work(worker, work)` æ¥æ‰§è¡Œæ¯ä¸ªå·¥ä½œé¡¹

#### 4. `kthread_init_work()` / `kthread_queue_work()`
```c
void kthread_init_work(struct kthread_work *work, void (*fn)(struct kthread_work *));
bool kthread_queue_work(struct kthread_worker *worker, struct kthread_work *work);
```
* åˆå§‹åŒ–ä¸€ä¸ª `work` å¯¹è±¡ï¼ŒæŒ‡å®šå‡½æ•°
* æäº¤ä»»åŠ¡åˆ°æŒ‡å®š `worker` çš„é˜Ÿåˆ—ä¸­ï¼Œè‡ªåŠ¨å”¤é†’çº¿ç¨‹

#### 5. `kthread_flush_work(struct kthread_work *work)`
* ç­‰å¾…è¿™ä¸ª work è¢«æ‰§è¡Œå®Œ
* ç±»ä¼¼ flush_work()ï¼Œç”¨äºåŒæ­¥

#### 6. `kthread_destroy_worker(struct kthread_worker *worker)`
* åœæ­¢çº¿ç¨‹å¹¶é‡Šæ”¾ worker èµ„æº
* é‡Šæ”¾èµ„æº

#### 7. `kthread_should_stop()`
* ç”¨äºçº¿ç¨‹ä¸»å‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦è¦é€€å‡º
* è‡ªå†™çº¿ç¨‹ loop æ—¶ä½¿ç”¨

---

### ç»“æ„å›¾ï¼šå„ç»„ä»¶å…³ç³»

#### kthread_create_worker è‡ªåŠ¨æ–¹å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      struct kthread_worker    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                          â”‚
â”‚ â”‚ spinlock_t lock          â”‚  â”‚                          â”‚
â”‚ â”‚ struct list_head list    â”‚  â”‚                          â”‚
â”‚ â”‚ struct task_struct *task â”‚  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                â”‚
             â”‚                            â”‚                â”‚
             â–¼                            â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     struct kthread_work    â”‚â”€â”€â”€â”€â”€â–ºâ”‚   kthread_queue_work()   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ struct list_head node â”‚  â”‚                  â”‚
â”‚ â”‚ void (*func)(...)     â”‚  â”‚                  â–¼
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ kthread_worker_fn()   â”‚
                                        â”‚ (çº¿ç¨‹ä¸»å¾ªç¯å‡½æ•°)      â”‚
                                        â”‚ while (!stop) {       â”‚
                                        â”‚    get work from list â”‚
                                        â”‚    call work->func()  â”‚
                                        â”‚ }                     â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### kthread_init_worker æ‰‹åŠ¨æ–¹å¼
```
æ‰‹åŠ¨æ–¹å¼æ•´ä½“ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               struct kthread_worker            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ spinlock_t lock                            â”‚ â”‚
â”‚ â”‚ struct list_head work_list                 â”‚ â”‚
â”‚ â”‚ struct task_struct *task (æœªè‡ªåŠ¨è®¾ç½®)      â”‚ â”‚â—„â”€â”€ ä½ è‡ªå·±å¿…é¡»å¯åŠ¨çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œ worker_fn
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–²
                        â”‚
                        â”‚   ä½¿ç”¨ï¼š
                        â”‚   kthread_init_worker(&worker);
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ struct kthread_work (ä»»åŠ¡é¡¹) â”‚   â”‚ çº¿ç¨‹ï¼šç”±ä½ è°ƒç”¨ kthread_run() åˆ›å»ºçš„    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ æ‰§è¡Œå‡½æ•°è°ƒç”¨ kthread_worker_fn()       â”‚
â”‚ â”‚ void (*func)(...)        â”‚ â”‚   â”‚ å®ƒä¼šä» worker->work_list ä¸­æ‹‰ä»»åŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æµç¨‹å›¾ï¼ˆæ—¶åºï¼‰

#### kthread_create_worker è‡ªåŠ¨æ–¹å¼
```
è‡ªå®šä¹‰æ¨¡å—åˆå§‹åŒ–å‡½æ•°
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ worker = kthread_create_worker(...);       â”‚â—„â”€â”€â”€â”€ å†…æ ¸åˆ›å»ºçº¿ç¨‹å¹¶è®¾ç½® worker->task
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kthread_init_work(&work, my_work_fn);      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kthread_queue_work(worker, &work);           â”‚â—„â”€â”€â”€â”€ æŠŠä»»åŠ¡æ”¾å…¥ worker->work_list
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†…æ ¸çº¿ç¨‹å¼€å§‹è¿è¡Œï¼škthread_worker_fn(worker)    â”‚
â”‚  --> while(1):                                 â”‚
â”‚       - ä» work_list å–å‡ºä»»åŠ¡                  â”‚
â”‚       - è°ƒç”¨ work->func(&work);                â”‚
â”‚       - ç»§ç»­ä¸‹ä¸€ä¸ª                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### kthread_init_worker æ‰‹åŠ¨æ–¹å¼
```
è‡ªå®šä¹‰æ¨¡å—åˆå§‹åŒ–å‡½æ•°
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ struct kthread_worker my_worker;    â”‚
â”‚ kthread_init_worker(&my_worker);    â”‚ â† åˆå§‹åŒ–ä½†ä¸å¯åŠ¨çº¿ç¨‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ task = kthread_run(my_thread_fn, ...);â”‚ â† ä½ è‡ªå·±åˆ›å»ºçº¿ç¨‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ int my_thread_fn(void *arg)              â”‚
â”‚ { return kthread_worker_fn(&my_worker); }â”‚ â† workerä¸»å‡½æ•°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kthread_worker_fn()                        â”‚
â”‚ - while (!kthread_should_stop()) {         â”‚
â”‚     work = get from work_list              â”‚
â”‚     call work->func()                      â”‚
â”‚   }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kthread_init_work(&work, my_work_fn);        â”‚
â”‚ kthread_queue_work(&my_worker, &work);       â”‚ â† æäº¤å·¥ä½œä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### è‡ªåŠ¨æ–¹å¼å’Œæ‰‹åŠ¨æ–¹å¼å¯¹æ¯”

| æ¯”è¾ƒé¡¹            | `kthread_create_worker()` è‡ªåŠ¨æ–¹å¼ | `kthread_init_worker()` æ‰‹åŠ¨æ–¹å¼ |
| ----------------- | ---------------------------------- | -------------------------------- |
| worker åˆ†é…       | è‡ªåŠ¨åˆ†é…å¹¶åˆå§‹åŒ–                   | è‡ªå·±åˆ†é…æ ˆä¸Šæˆ–å †ä¸Š               |
| çº¿ç¨‹åˆ›å»º          | å†…éƒ¨åˆ›å»ºå¹¶ç»‘å®š                     | è‡ªå·±ç”¨ `kthread_run()` åˆ›å»º      |
| ä¸»å‡½æ•°            | å†…éƒ¨ç»‘å®š `kthread_worker_fn()`     | æ‰‹åŠ¨å†™çº¿ç¨‹å‡½æ•°è°ƒç”¨å®ƒ             |
| worker->task è®¾ç½® | è‡ªåŠ¨è®¾ç½®ä¸ºçº¿ç¨‹                     | å¿…é¡»æ‰‹åŠ¨è®¾ç½®æˆ–å¿½ç•¥å®ƒ             |
| çµæ´»æ€§            | ç®€æ´å°è£…                           | æ›´çµæ´»å¯æ§ï¼ˆä¼˜å…ˆçº§ã€ç»‘å®š CPU ç­‰ï¼‰|
| æ¨èç¨‹åº¦          | âœ… é«˜                              | âš ï¸ ä¸­ï¼ˆæœ‰éœ€æ±‚æ—¶ï¼‰                 |

---

### ä¸ºä»€ä¹ˆ **ä¸èƒ½** æ‰‹åŠ¨è°ƒç”¨ `kthread_worker_fn`ï¼Ÿ

å› ä¸ºå®ƒæ˜¯**çº¿ç¨‹ä¸»å¾ªç¯å‡½æ•°**ï¼Œä¸æ˜¯ä½ ä¸šåŠ¡é€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚

#### ä¸¾ä¾‹è¯´æ˜ï¼š

è¿™æ ·å†™ï¼š
```c
task = kthread_run(kthread_worker_fn, worker, "my_kthread");
```

é—®é¢˜æ¥äº†ï¼š
* `worker->task` æ˜¯ç©ºçš„
* `kthread_worker_fn` è¿›æ¥ä¼š `WARN_ON(worker->task != current)`
* å´©äº† âŒ

è€Œå†…æ ¸åŸå§‹è®¾è®¡æ˜¯è¿™æ ·çš„ï¼š
```c
worker = kthread_create_worker();
  -> è°ƒç”¨ kthread_create(kthread_worker_fn, worker, ...)
     -> è®¾ç½® worker->task = åˆ›å»ºçš„çº¿ç¨‹
```

ç»•è¿‡ `kthread_create_worker`ï¼Œå°±ç ´åäº†è¿™ä¸ªæœºåˆ¶ã€‚

---

#### æœ€å°åˆæ³•ç”¨æ³•ç¤ºä¾‹

```c
static struct kthread_worker *worker;
static struct kthread_work my_work;

void my_work_fn(struct kthread_work *work)
{
    pr_info("Running my work function!\n");
}

static int __init mymod_init(void)
{
    worker = kthread_create_worker(0, "my_worker_thread");
    if (IS_ERR(worker)) {
        pr_err("Failed to create worker thread\n");
        return PTR_ERR(worker);
    }

    kthread_init_work(&my_work, my_work_fn);
    kthread_queue_work(worker, &my_work);
    return 0;
}

static void __exit mymod_exit(void)
{
    kthread_destroy_worker(worker);
}
```

åªéœ€ç®¡ï¼š
* å®šä¹‰å¥½ `work` å’Œ `my_work_fn`
* ç”¨ `kthread_create_worker()` åˆ›å»ºçº¿ç¨‹
* æäº¤ `kthread_queue_work()` å³å¯


---

#### é”™è¯¯åšæ³• vs æ­£ç¡®åšæ³•å¯¹æ¯”

| é”™è¯¯ä»£ç                               | é—®é¢˜                                                     |
| ------------------------------------- | -------------------------------------------------------- |
| `kthread_run(kthread_worker_fn, ...)` | **é”™è¯¯**ä½¿ç”¨äº†å†…æ ¸çº¿ç¨‹çš„ä¸»å¾ªç¯å‡½æ•°ï¼Œç»•è¿‡äº† worker åˆå§‹åŒ– |
| `worker->task == NULL`                | ä¼šè§¦å‘ `WARN_ON()`ï¼Œçº¿ç¨‹æœªç»‘å®šåˆ° worker ä¸Š               |

| æ­£ç¡®æ–¹å¼                               | è¯´æ˜                               |
| -------------------------------------- | ---------------------------------- |
| `worker = kthread_create_worker(...);` | è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹ï¼Œç»‘å®š `worker->task`  |
| æäº¤å·¥ä½œé¡¹                             | ç”¨ `kthread_queue_work()` æ­£å¸¸è°ƒåº¦ |

---

#### ç”¨ `kthread_run()` åˆ›å»ºçº¿ç¨‹ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ

å°±**åˆ«ç”¨ `kthread_worker` ç³»ç»Ÿ**ï¼Œç›´æ¥è‡ªå·±å†™ä¸ªçº¿ç¨‹å‡½æ•°ï¼š

```c
int my_thread_fn(void *arg)
{
    while (!kthread_should_stop()) {
        // do something
        msleep(1000);  // æ¨¡æ‹Ÿå‘¨æœŸä»»åŠ¡
    }
    return 0;
}
```

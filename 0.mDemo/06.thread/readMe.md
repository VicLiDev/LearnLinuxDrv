# `task_struct`„ÄÅ`kthread_worker`„ÄÅ`work_struct` Âíå `delayed_work`

---

## ‰∏ÄËßàÔºöÂõõËÄÖÁöÑÂØπÊØî

Âú® Linux ÂÜÖÊ†∏‰∏≠ÔºåÊúâÂ§öÁßçÊú∫Âà∂Áî®‰∫éÂºÇÊ≠•‰ªªÂä°Â§ÑÁêÜÂíåÁ∫øÁ®ãÊéßÂà∂„ÄÇ‰ª•‰∏ãÊòØÂ∏∏Áî®ÁöÑÂá†ÁßçÁªìÊûÑÂèäÂÖ∂Â∑ÆÂºÇÔºö

1. **`task_struct`**
   * **Á±ªÂûã**ÔºöÊï∞ÊçÆÁªìÊûÑ
   * **Êú∫Âà∂Á±ªÂà´**ÔºöÁ∫øÁ®ã/ËøõÁ®ãË∞ÉÂ∫¶Á≥ªÁªü
   * **Áî®ÈÄî**ÔºöË°®Á§∫ÂÜÖÊ†∏‰∏≠ÊØè‰∏Ä‰∏™Á∫øÁ®ãÊàñËøõÁ®ãÁöÑÊ†∏ÂøÉÊèèËø∞Á¨¶„ÄÇÂåÖÂê´Ë∞ÉÂ∫¶Áä∂ÊÄÅ„ÄÅÂÜÖÂ≠ò‰ø°ÊÅØ„ÄÅ‰ø°Âè∑„ÄÅ
     CPU ÁªëÂÆöÁ≠â„ÄÇ
   * **ÊòØÂê¶ÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®Êúü**Ôºö‚úÖ ÊîØÊåÅÂÆåÂÖ®ÊéßÂà∂ÔºàÂ¶ÇÂàõÂª∫„ÄÅÂÅúÊ≠¢„ÄÅÂî§ÈÜíÁ≠âÔºâ
   * **ÊòØÂê¶ÊîØÊåÅÂª∂ËøüÊâßË°å**Ôºö‚ùå ‰∏çÊîØÊåÅÂª∂ËøüË∞ÉÂ∫¶ÈÄªËæëÔºàÈúÄÈÖçÂêàÂÆöÊó∂Âô®Ôºâ
   * **ËøêË°å‰∏ä‰∏ãÊñá**ÔºöÂÜÖÊ†∏Á∫øÁ®ãÊàñËøõÁ®ã‰∏ä‰∏ãÊñá
   * **ÂÖ∏ÂûãÁî®Ê≥ï**Ôºö`kthread_create()` ÂàõÂª∫ÂÜÖÊ†∏Á∫øÁ®ã„ÄÅËÆøÈóÆÂΩìÂâçÁ∫øÁ®ãÁî® `current`ÔºåË∞ÉËØïÊàñ
     Ë∞ÉÂ∫¶Êìç‰ΩúÁ≠â

2. **`kthread_worker`**
   * **Á±ªÂûã**ÔºöÊï∞ÊçÆÁªìÊûÑ
   * **Êú∫Âà∂Á±ªÂà´**ÔºöËá™ÂÆö‰πâÁ∫øÁ®ãÂ∑•‰ΩúÈòüÂàó
   * **Áî®ÈÄî**ÔºöË∞ÉÂ∫¶Â§ö‰∏™ `kthread_work` Êàñ `kthread_delayed_work`ÔºåÁî±‰∏Ä‰∏™ÂÜÖÊ†∏Á∫øÁ®ãËøêË°åÔºå
     ÈÄÇÁî®‰∫éÈ©±Âä®Á≠âÂØπÁ∫øÁ®ãÊéßÂà∂Ë¶ÅÊ±ÇÈ´òÁöÑÂú∫ÊôØ„ÄÇ
   * **ÊòØÂê¶ÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®Êúü**Ôºö‚úÖ ÂèØ‰ª•ÊéßÂà∂ÔºàÁî±‰Ω†ÂàõÂª∫ÂíåÁÆ°ÁêÜÁ∫øÁ®ãÔºâ
   * **ÊòØÂê¶ÊîØÊåÅÂª∂ËøüÊâßË°å**Ôºö‚úÖ ÊîØÊåÅÔºà‰ΩøÁî® `kthread_delayed_work`Ôºâ
   * **ËøêË°å‰∏ä‰∏ãÊñá**ÔºöÂÜÖÊ†∏Á∫øÁ®ã‰∏ä‰∏ãÊñá
   * **ÂÖ∏ÂûãÁî®Ê≥ï**ÔºöÂàùÂßãÂåñ‰∏Ä‰∏™ `kthread_worker`ÔºåÁî® `kthread_run()` ÂàõÂª∫Á∫øÁ®ãÊâßË°å
     `kthread_worker_fn()`ÔºåÈÄÇÁî®‰∫éÈïøÊúüËøêË°åÁöÑ worker Á∫øÁ®ãÂú∫ÊôØ

3. **`work_struct`**
   * **Á±ªÂûã**ÔºöÊï∞ÊçÆÁªìÊûÑ
   * **Êú∫Âà∂Á±ªÂà´**ÔºöÂ∑•‰ΩúÈòüÂàóÔºàworkqueueÔºâ
   * **Áî®ÈÄî**ÔºöÊèê‰∫§‰∏Ä‰∏™ÂºÇÊ≠•ÂáΩÊï∞Âà∞ÂÜÖÊ†∏ÁöÑÁ≥ªÁªüÂ∑•‰ΩúÁ∫øÁ®ãÊ±†‰∏≠ÊâßË°åÔºåÈÄÇÂêàÁü≠Êó∂„ÄÅËΩªÈáèÁöÑ‰ªªÂä°„ÄÇ
   * **ÊòØÂê¶ÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®Êúü**Ôºö‚ùå ‰∏çÊîØÊåÅÔºàÁ∫øÁ®ãÁî±ÂÜÖÊ†∏Áªü‰∏ÄÁÆ°ÁêÜÔºâ
   * **ÊòØÂê¶ÊîØÊåÅÂª∂ËøüÊâßË°å**Ôºö‚ùå ‰∏çÊîØÊåÅÔºà‰∏çËÉΩÁõ¥Êé•Âª∂ËøüÔºåÈúÄË¶ÅÈÖçÂêà `delayed_work`Ôºâ
   * **ËøêË°å‰∏ä‰∏ãÊñá**ÔºöËΩØ‰∏≠Êñ≠‰∏ä‰∏ãÊñáÊàñÂ∑•‰ΩúÁ∫øÁ®ã‰∏ä‰∏ãÊñáÔºàÈùû‰∏≠Êñ≠Ôºâ
   * **ÂÖ∏ÂûãÁî®Ê≥ï**Ôºö‰ΩøÁî® `INIT_WORK()` ÂàùÂßãÂåñÔºåË∞ÉÁî® `schedule_work()` Êèê‰∫§‰ªªÂä°

4. **`delayed_work`**
   * **Á±ªÂûã**ÔºöÁªìÊûÑ‰ΩìÂÆèÔºàÂåÖÂê´ `work_struct` + `timer_list`Ôºâ
   * **Êú∫Âà∂Á±ªÂà´**ÔºöÂª∂ËøüÂ∑•‰ΩúÈòüÂàó
   * **Áî®ÈÄî**ÔºöÂú®Âª∂Ëøü‰∏ÄÊÆµÊó∂Èó¥ÂêéÔºåÂ∞Ü‰ªªÂä°Êèê‰∫§ÁªôÁ≥ªÁªüÂ∑•‰ΩúÈòüÂàóÊâßË°å„ÄÇ
   * **ÊòØÂê¶ÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®Êúü**Ôºö‚ùå ‰∏çÊîØÊåÅÔºà‰ΩøÁî®Á≥ªÁªüÁ∫øÁ®ãÊ±†Ôºâ
   * **ÊòØÂê¶ÊîØÊåÅÂª∂ËøüÊâßË°å**Ôºö‚úÖ ÊîØÊåÅÔºàÈÄöËøáÂÆöÊó∂Âô®Êú∫Âà∂Ôºâ
   * **ËøêË°å‰∏ä‰∏ãÊñá**ÔºöÂêå `work_struct`ÔºåËøêË°åÂú®Â∑•‰ΩúÈòüÂàóÁ∫øÁ®ã‰∏≠
   * **ÂÖ∏ÂûãÁî®Ê≥ï**Ôºö‰ΩøÁî® `INIT_DELAYED_WORK()` ÂàùÂßãÂåñÔºåË∞ÉÁî® `schedule_delayed_work()`
     ËÆæÁΩÆÂª∂ËøüÂπ∂Êèê‰∫§ÊâßË°å

tops:
* `task_struct` ÊòØÁ∫øÁ®ãÁöÑÂü∫Á°ÄÔºåË¥ØÁ©øÊâÄÊúâÊú∫Âà∂„ÄÇ
* `work_struct` Âíå `delayed_work` ÊòØ **‚ÄúÈù¢Âêë‰ªªÂä°‚ÄùÁöÑÈòüÂàóÊâßË°åÊú∫Âà∂**„ÄÇ
* `kthread_worker` ÊòØ **‚ÄúÈù¢ÂêëÁ∫øÁ®ã‚ÄùÁöÑÊâßË°åÊú∫Âà∂** ÔºåÊõ¥Âº∫Â§ß‰ΩÜ‰πüÈúÄË¶ÅËá™Â∑±ÁÆ°ÁêÜÁ∫øÁ®ãÁîüÂëΩÂë®Êúü„ÄÇ

## kthread_worker/work_struct ËØ¶ÁªÜÂØπÊØî

kthread_worker Âíå work_struct Ê≤°ÊúâÂåÖÂê´ÂÖ≥Á≥ªÔºåÂ±û‰∫éÂÆåÂÖ®**‰∏çÂêåÁöÑÊú∫Âà∂„ÄÇ
ÂÆÉ‰ª¨ÂàÜÂà´ÊúçÂä°‰∫é‰∏§Áßç‰∏çÂêåÁöÑÂ∑•‰ΩúÈòüÂàóÊ®°ÂûãÔºö
| È°πÁõÆ             | `kthread_worker`                          | `work_struct`                        |
| ---------------- | ----------------------------------------- | ------------------------------------ |
| Â∑•‰ΩúÊ®°Âûã         | Ëá™Âª∫Á∫øÁ®ã ‚Üí ÊâßË°åÂ§ö‰∏™‰ªªÂä°                   | Á≥ªÁªüÂÜÖÊ†∏Á∫øÁ®ãÊ±† ‚Üí ÊâßË°å‰∏Ä‰∏™‰∏™‰ªªÂä°      |
| ‰ªªÊÑèÁ∫øÁ®ãÊâßË°åÔºü   | Âè™Âú®ÁªëÂÆöÁöÑ `kthread_worker` Á∫øÁ®ãÊâßË°å      | ‰ªªÊÑèÁî±ÂÜÖÊ†∏Ë∞ÉÂ∫¶ÁöÑ worker Á∫øÁ®ã         |
| ÊéßÂà∂Âäõ           | È´òÂ∫¶ÊéßÂà∂Á∫øÁ®ãË°å‰∏∫                          | Êó†Ê≥ïÊéßÂà∂ÂÖ∑‰ΩìÊâßË°åÁ∫øÁ®ã                 |
| ÊòØÂê¶ÊúâÂåÖÂê´ÂÖ≥Á≥ªÔºü | Êó†‰ªª‰ΩïÁªìÊûÑ‰ΩìÂ±ÇÁ∫ßÊàñÂµåÂ•óÂÖ≥Á≥ª                | ‰∏é `kthread_worker` ÂÆåÂÖ®Êó†ÂÖ≥         |
| Á∫øÁ®ãÁîüÂëΩÂë®Êúü     | ÈúÄË¶ÅË¥üË¥£ÂàõÂª∫„ÄÅÂÅúÊ≠¢ `kthread_worker` Á∫øÁ®ã  | ÂÜÖÊ†∏ÁÆ°ÁêÜÁ∫øÁ®ãÊ±†ÁîüÂëΩÂë®Êúü               |
| Êé•Âè£Ë∞ÉÁî®         | `kthread_queue_work()` Á≠â                 | `schedule_work()`„ÄÅ`flush_work()` Á≠â |


Á±ªÊØîÁêÜËß£ÔºàÊâìÂ∑•Ê®°ÂûãÔºâÔºö
| Ê¶ÇÂøµ             | Á±ªÊØîËßíËâ≤                     | ÁâπÁÇπ                       |
| ---------------- | ---------------------------- | -------------------------- |
| `work_struct`    | ÁªôÁ≥ªÁªü‰∏¥Êó∂ÊâæÁöÑÊâìÂ∑•‰∫∫         | ‰∫∫ÊòØË∞Å‰∏çÈáçË¶ÅÔºåÂè™Ë¶ÅÂπ≤Ê¥ªÂ∞±Ë°å |
| `kthread_worker` | Ëá™Â∑±ÈõáÁöÑÂëòÂ∑•Âõ¢Èòü             | ÂøÖÈ°ªÂú®‰Ω†ÂÆâÊéíÁöÑÁ∫øÁ®ãÈáåÂ∑•‰Ωú   |
| `kthread_work`   | ÂàÜÁªô `kthread_worker` ÁöÑ‰ªªÂä° | ÂÆÉ‰∏çËÉΩÊäïÁªô `work_struct`   |



### Â∑•‰ΩúÈÄªËæëÂØπÊØî

| ÁâπÊÄß              | `work_struct`ÔºàÈÄöÁî®Â∑•‰ΩúÈòüÂàóÔºâ                                            | `kthread_work`ÔºàÂÜÖÊ†∏Á∫øÁ®ãÂ∑•‰ΩúÈòüÂàóÔºâ                                     |
| ----------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------- |
| **Ê†∏ÂøÉÊÄùÊÉ≥**      | Êää‰ªªÂä°ÊîæËøõÂÜÖÊ†∏**ÂÖ®Â±Ä/Ëá™ÂÆö‰πâ workqueue**ÔºåÁî± worker Á∫øÁ®ãÊ±†ÊâßË°å            | Êää‰ªªÂä°ÊîæËøõ‰Ω†Ëá™Â∑±ÂàõÂª∫ÁöÑ **kthread_worker** ÈòüÂàóÔºåÁî±‰Ω†Ëá™Â∑±ÁöÑÂÜÖÊ†∏Á∫øÁ®ãÊâßË°å |
| **Ë∞ÉÂ∫¶‰∏ª‰Ωì**      | Á≥ªÁªüÁª¥Êä§ÁöÑ **kworker** Á∫øÁ®ãÊ±†ÔºàÊØè CPU ÈÄöÂ∏∏‰∏Ä‰∏™ÊàñÂ§ö‰∏™Á∫øÁ®ãÔºâ               | ‰Ω†ÂàõÂª∫ÁöÑ **kthread_worker**ÔºàÈÄöÂ∏∏Â∞±ÊòØ‰∏Ä‰∏™ÂÜÖÊ†∏Á∫øÁ®ãÔºâ                    |
| **ÂàùÂßãÂåñ**        | `INIT_WORK(&work, handler)`                                              | `kthread_init_work(&work, handler)`                                    |
| **Êèê‰∫§‰ªªÂä°**      | `schedule_work(&work)`ÔºàÈªòËÆ§ÈòüÂàóÔºâÊàñ `queue_work(wq, &work)`ÔºàÊåáÂÆöÈòüÂàóÔºâ | `kthread_queue_work(worker, &work)`                                    |
| **‰ªªÂä°Â≠òÂÇ®‰ΩçÁΩÆ**  | workqueue ÁöÑÈìæË°®                                                         | kthread_worker ÁöÑÈìæË°®                                                  |
| **ÊâßË°åÁ∫øÁ®ãÊï∞Èáè**  | ÈªòËÆ§ÊòØÂ§öÁ∫øÁ®ãÔºàÂèØËÉΩË∑® CPU Âπ∂Ë°åÔºâ                                          | ‰∏ÄËà¨ÂçïÁ∫øÁ®ãÔºà‰∏≤Ë°åÊâßË°åÔºâ                                                 |
| **Á∫øÁ®ãÊéßÂà∂ÊùÉ**    | ÂÆåÂÖ®Áî±ÂÜÖÊ†∏Ë∞ÉÂ∫¶                                                           | Áî±‰Ω†ÂÆåÂÖ®ÊéßÂà∂ÔºàÂèØÊöÇÂÅú„ÄÅÂÅúÊ≠¢„ÄÅÁªëÂÆö CPUÔºâ                                 |
| **CPU ‰∫≤ÂíåÊÄß**    | Á≥ªÁªüËá™Âä®ÈÄâÊã©ÔºàÂèØËÉΩË∑® CPUÔºâ                                               | ‰Ω†ÂèØ‰ª•ÁªëÊ≠ªÂà∞ÊåáÂÆö CPU                                                   |
| **‰ΩøÁî®Âú∫ÊôØ**      | Áü≠Â∞èÂºÇÊ≠•‰ªªÂä°Ôºå‰∏çÈúÄË¶Å‰∏•Ê†ºÈ°∫Â∫è                                             | ÈïøËÄóÊó∂‰ªªÂä°„ÄÅÈúÄË¶Å‰∏≤Ë°åÈ°∫Â∫è„ÄÅÈúÄË¶ÅÁ≤æÁ°ÆÁ∫øÁ®ãÊéßÂà∂                             |

---

### Âπ∂Ë°åÊÄßÂØπÊØî

#### `work_struct`

* **ÈªòËÆ§ workqueue** ‚Üí Â§ö worker Á∫øÁ®ã ‚Üí Â§ö CPU ‰∏äÂèØÂπ∂Ë°åÊâßË°å‰∏çÂêå‰ªªÂä°
* Âêå‰∏Ä‰∏™ `struct work_struct` ‰ªªÂä°Ôºö
  * **‰∏çËÉΩÂπ∂Ë°å**ÔºàÂõ†‰∏∫ÂÜÖÈÉ®Êúâ `pending` Ê†áÂøóÔºâ
  * Â¶ÇÊûú‰ªªÂä°Ê≠£Âú®ÊâßË°åÔºåÈáçÂ§çÊèê‰∫§‰ºöË¢´ÂøΩÁï•
* ‰∏çÂêåÁöÑ `struct work_struct` ‚Üí **ÂèØËÉΩÂêåÊó∂ËøêË°åÂú®‰∏çÂêå CPU**

---

#### `kthread_work`

* Âêå‰∏Ä‰∏™ `kthread_worker` **‰∏ÄÊ¨°Âè™ÊâßË°å‰∏Ä‰∏™‰ªªÂä°** ‚Üí **ÁªùÂØπ‰∏≤Ë°å**
* Âç≥‰ΩøÊèê‰∫§Â§ö‰∏™‰ªªÂä°Ôºå‰πü‰ºö‰∏Ä‰∏™Êé•‰∏Ä‰∏™ÊâßË°å
* Â¶ÇÊûúË¶ÅÂπ∂Ë°åÔºåÈúÄË¶ÅËá™Â∑±ÂàõÂª∫Â§ö‰∏™ `kthread_worker`ÔºàÂ§ö‰∏™Á∫øÁ®ãÔºâ

---

### ÊâßË°åÊµÅÁ®ãÂõæ

```
work_structÔºàÂ§öÁ∫øÁ®ãÊ®°ÂûãÔºâ:
   schedule_work() ‚Üí Âä†ÂÖ• system_wq
                     ‚Üì
            Â§ö‰∏™ kworker Á∫øÁ®ã‰∫âÊä¢‰ªªÂä°
             CPU0 ÊâßË°å‰ªªÂä°A   CPU1 ÊâßË°å‰ªªÂä°B   CPU2 ÊâßË°å‰ªªÂä°C
            ÔºàÂπ∂Ë°åÊâßË°åÔºâ

kthread_workÔºàÂçïÁ∫øÁ®ãÊ®°ÂûãÔºâ:
   kthread_queue_work() ‚Üí Âä†ÂÖ• kthread_worker ÈòüÂàó
                            ‚Üì
             ÂîØ‰∏ÄÁöÑ worker Á∫øÁ®ãÈ°∫Â∫èÂèñ‰ªªÂä°
              ÊâßË°å‰ªªÂä°A ‚Üí ÊâßË°å‰ªªÂä°B ‚Üí ÊâßË°å‰ªªÂä°C
            Ôºà‰∏•Ê†º‰∏≤Ë°åÔºâ
```

---

### ÊÄªÁªì

* **ÊÉ≥ÁúÅ‰∫ã** ‚Üí Áî® `work_struct`ÔºåÁî±Á≥ªÁªüÁ∫øÁ®ãÊ±†Ëá™Âä®Âπ∂Ë°åË∞ÉÂ∫¶
* **ÊÉ≥‰øùËØÅÈ°∫Â∫è** / **ÈïøËÄóÊó∂‰ªªÂä°** / **Á≤æÁ°ÆÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®Êúü** ‚Üí Áî® `kthread_work`
* **Âêå‰∏Ä‰∏™‰ªªÂä°ÁªìÊûÑ‰Ωì**ÔºàÊó†ËÆ∫Âì™ÁßçÔºâÂú®ÊâßË°å‰∏≠‰∏ç‰ºöË¢´Âπ∂Ë°åËøêË°åÔºå‰ΩÜ‰∏çÂêå‰ªªÂä°ÁöÑÂπ∂Ë°åÊÉÖÂÜµÂèñÂÜ≥‰∫éÁ∫øÁ®ãÊ®°Âûã


---

## 1. `struct task_struct`

> üîß **ÂÜÖÊ†∏‰∏≠ÊØè‰∏™Á∫øÁ®ãÔºàÂåÖÊã¨ÂÜÖÊ†∏Á∫øÁ®ãÂíåÁî®Êà∑ËøõÁ®ãÔºâÁöÑÊèèËø∞Á¨¶**

* ÂåÖÂê´Ë∞ÉÂ∫¶‰ø°ÊÅØ„ÄÅÂÜÖÂ≠òÊò†Â∞Ñ„ÄÅÁä∂ÊÄÅÁ≠â„ÄÇ
* ÂÜÖÊ†∏Á∫øÁ®ã‰ΩøÁî®ÂÆÉÈÄöËøá `kthread_create()` / `kthread_run()` ÂàõÂª∫„ÄÇ
* Áî®Êà∑Á©∫Èó¥ËøõÁ®ã‰πü‰ΩøÁî®ÂÆÉÔºåÊòØ `current` ÂÆèËøîÂõûÁöÑÂÜÖÂÆπ„ÄÇ

```c
struct task_struct *t = current;
pr_info("Current task is: %s (pid: %d)", t->comm, t->pid);
```

* ‰ΩøÁî®Âú∫ÊôØÔºöË∞ÉËØïÁ∫øÁ®ã„ÄÅË∞ÉÂ∫¶ÊéßÂà∂„ÄÅÈòªÂ°ûÂî§ÈÜí„ÄÅË∞ÉËØïÁ≠â„ÄÇ

---

## 2. `struct kthread_worker`

> üßµ **‰∏Ä‰∏™‰∏ìÈó®Â§ÑÁêÜ `kthread_work` ÁöÑÂ∑•‰ΩúËÄÖÁ∫øÁ®ãË∞ÉÂ∫¶Âô®**

* Áî®‰∫éË∞ÉÂ∫¶Â§ö‰∏™ `kthread_work` Âíå `kthread_delayed_work`„ÄÇ
* Ëá™ÂÆö‰πâÁ∫øÁ®ãÊéßÂà∂ÔºåÈÄÇÂêàÈ©±Âä®ÊàñÊ®°ÂùóÂÜÖÁöÑÂ∑•‰ΩúÊ±†ÈúÄÊ±Ç„ÄÇ
* ÂøÖÈ°ªÁªìÂêà‰∏Ä‰∏™ `task_struct` Êù•ËøêË°åÔºåÂ¶ÇÔºö

```c
kthread_init_worker(&worker);
task_struct *thread = kthread_run(kthread_worker_fn, &worker, "my_worker");
```

* ÂèØ‰ª•ÊâãÂä®Ë∞ÉÂ∫¶„ÄÅÂª∂Ëøü„ÄÅÂèñÊ∂à„ÄÅÂêåÊ≠•Á≠âÂæÖ‰ªªÂä°ÂÆåÊàê„ÄÇ

ÈÄÇÂêàÂØπÁ∫øÁ®ãÊéßÂà∂ÊúâÊòéÁ°ÆÈúÄÊ±ÇÁöÑÂú∫ÊôØÔºå‰æãÂ¶ÇÔºö
‚úî ÂÆûÊó∂È©±Âä®
‚úî Â§ßÈáèÂºÇÊ≠•‰ªªÂä°ÊéíÈòüÊâßË°å
‚úî ÂèØÂèñÊ∂à‰ªªÂä°Ê®°Âûã

---

## 3. `struct work_struct`

> ‚öôÔ∏è **‰∏Ä‰∏™ÂáΩÊï∞ÂåÖË£ÖÂô®ÔºåÁî®‰∫éÊèê‰∫§ÂºÇÊ≠•‰ªªÂä°Âà∞Á≥ªÁªüÂ∑•‰ΩúÈòüÂàó**

* ÈÖçÂêà `INIT_WORK()` Âíå `schedule_work()` ‰ΩøÁî®„ÄÇ
* ÈÄÇÂêàËΩªÈáèÁ∫ß„ÄÅÈùûÂÆûÊó∂ÁöÑÂºÇÊ≠•Â§ÑÁêÜ„ÄÇ
* ‰∏çÁªëÂÆöÁâπÂÆöÁ∫øÁ®ãÔºåÁî±Á≥ªÁªüÂÖ®Â±ÄÁ∫øÁ®ãÊ±†Ëá™Âä®Ë∞ÉÂ∫¶„ÄÇ

Á§∫‰æãÔºö

```c
INIT_WORK(&my_work, work_func);
schedule_work(&my_work);
```

* ÈÄöÂ∏∏ËøêË°åÂú® `kworker/*` Á≥ªÁªüÁ∫øÁ®ã‰∏≠„ÄÇ
* ‰∏ÄËà¨‰∏ç‰øùËØÅÂÆûÊó∂ÊÄß„ÄÅ‰∏ç‰øùËØÅÈ°∫Â∫èÔºå‰∏çÈÄÇÂêàÂ§ÑÁêÜÊó∂Â∫èÊïèÊÑüÊàñ‰∫íÊñ•Âº∫ÁöÑÂú∫ÊôØ„ÄÇ

---

## 4. `struct delayed_work`

> ‚è≥ **Â∏¶ÂÆöÊó∂Âô®ÁöÑÂª∂ËøüÁâàÊú¨ work_struct**

* ÂÆûË¥®ÊòØ‰∏Ä‰∏™ÁªìÊûÑ‰ΩìÁªÑÂêàÔºö

```c
struct delayed_work {
    struct work_struct work;
    struct timer_list timer;
};
```

* Áî®‰∫éÂª∂ËøüÊâßË°å‰ªªÂä°ÔºåÈÄÇÂêàÂÆöÊó∂ÈáçËØï„ÄÅtimeout handler Á≠â„ÄÇ

```c
INIT_DELAYED_WORK(&dw, work_func);
schedule_delayed_work(&dw, msecs_to_jiffies(1000)); // 1ÁßíÂêéÊâßË°å
```

* ÊâßË°åÊó∂Êú∫Èù†ÂÆöÊó∂Âô®Ë∞ÉÂ∫¶ÔºåÁÑ∂ÂêéËá™Âä®Êèê‰∫§Âà∞Á≥ªÁªüÂ∑•‰ΩúÈòüÂàó„ÄÇ

---

## ‰ΩøÁî®Âª∫ËÆÆÂíåÂÖ∏ÂûãÁªÑÂêà

| ÁõÆÊ†á                                   | Âª∫ËÆÆÁî®Ê≥ï                          | ÂéüÂõ†                         |
| -------------------------------------- | --------------------------------- | ---------------------------- |
| ÈúÄË¶ÅÂàõÂª∫‰Ω†Ëá™Â∑±ÁöÑÁ∫øÁ®ãÔºåÂπ∂Ë∞ÉÂ∫¶Â§ö‰∏™Â∑•‰ΩúÈ°π | `kthread_worker` + `kthread_work` | ÁÅµÊ¥ª„ÄÅÈ´òÊÄßËÉΩ„ÄÅÂèØÂèñÊ∂à„ÄÅÂèØÂπ∂Ë°å |
| ÈúÄË¶Å‰∏ÄÊ¨°ÊÄßÁöÑÂºÇÊ≠•ÊâßË°åÂáΩÊï∞               | `work_struct`                     | ÁÆÄÂçïËΩªÈáèÔºå‰∏çÈúÄÁÆ°ÁêÜÁ∫øÁ®ã       |
| ÈúÄË¶ÅÂª∂Ëøü‰∏ÄÊÆµÊó∂Èó¥ÂêéÂºÇÊ≠•ÊâßË°å‰ªªÂä°         | `delayed_work`                    | ‰ΩøÁî®ÂÜÖÊ†∏ÂÆöÊó∂Âô®Ë∞ÉÂ∫¶‰ªªÂä°       |
| ÊéßÂà∂Á∫øÁ®ãË°å‰∏∫ÔºàÁù°Áú†„ÄÅÈòªÂ°û„ÄÅ‰ø°Âè∑Ôºâ       | `task_struct`                     | Á∫øÁ®ãÊéßÂà∂Ê†∏ÂøÉÁªìÊûÑ             |


## kthread_worker ËØ¶Ëß£

---

### ‰ªÄ‰πàÊòØ `kthread_worker` Êú∫Âà∂Ôºü

`kthread_worker` ÊòØ Linux ÂÜÖÊ†∏Êèê‰æõÁöÑ‰∏Ä‰∏™**Âü∫‰∫éÂÜÖÊ†∏Á∫øÁ®ãÁöÑÂºÇÊ≠•Â∑•‰ΩúÈòüÂàóÁ≥ªÁªü**„ÄÇ
ÂÆÉË∑ü `workqueue` Á±ª‰ººÔºå‰ΩÜÊõ¥ËΩªÈáè„ÄÅÁßÅÊúâ„ÄÅÂÆûÊó∂ÊÄßÊõ¥ÂèØÊéß„ÄÇ

ÂÆÉÂÜÖÈÉ®ÈÄöËøáÔºö
* ‰∏Ä‰∏™ÂÜÖÊ†∏Á∫øÁ®ãÔºàkthreadÔºâ
* ‰∏Ä‰∏™Â∑•‰ΩúÈòüÂàóÔºàFIFO ÈòüÂàóÔºâ
* ‰∏çÊñ≠‰ªéÈòüÂàóÂèñÂá∫‰ªªÂä°ÊâßË°å

Êù•ÂÆåÊàêÂºÇÊ≠•‰ªªÂä°Â§ÑÁêÜ„ÄÇ

---

### Ê†∏ÂøÉÁªìÊûÑ‰ΩìÂíåÂáΩÊï∞ÂÖ≥Á≥ªÂõæ

Êåâ**ÁªìÊûÑ‰Ωì** Âíå **ÂáΩÊï∞** Êù•ÁêÜÊ∏ÖÊ•öË∞ÅË¥üË¥£ÂÅö‰ªÄ‰πàÔºö
```
Ëá™ÂÆö‰πâÂ∑•‰ΩúÂáΩÊï∞Ôºàvoid my_work_fn(struct kthread_work *work)Ôºâ
         ‚Üë
   ÊâßË°åÂô®Ôºö__kthread_run_work(worker, work)
         ‚Üë
Â∑•‰ΩúÁ∫øÁ®ãÔºökthread_worker_fn(worker)  <-- Ê≥®ÊÑèËøô‰∏™ÔºÅÔºÅ
         ‚Üë
ÂàõÂª∫ÂáΩÊï∞Ôºökthread_create_worker()
         ‚Üë
ÂêØÂä®Á∫øÁ®ãÔºökthread_create() ÂÜÖÈÉ®Ë∞ÉÁî®ÁöÑÁ∫øÁ®ã‰∏ª‰ΩìÂ∞±ÊòØ kthread_worker_fn
```

---

### ‰∏ªË¶ÅÁªìÊûÑ‰ΩìËß£Êûê

#### 1. `struct kthread_worker`

```c
struct kthread_worker {
    spinlock_t lock;
    struct list_head work_list;     // Â≠òÊîæ kthread_work
    struct task_struct *task;      // Á∫øÁ®ãÊú¨‰ΩìÔºàkthread_create() ÁîüÊàêÔºâ
};
```

ÂÆÉÂ∞±ÊòØ‰∏Ä‰∏™Êï¥‰ΩìÂÆπÂô®ÔºåÂåÖÂê´‰∫ÜÔºö
* ‰∏Ä‰∏™‚Äú‰ªªÂä°ÈòüÂàó‚Äù
* ‰∏Ä‰∏™‚ÄúÁ∫øÁ®ã‚Äù

---

#### 2. `struct kthread_work`

```c
struct kthread_work {
    struct list_head node;
    void (*func)(struct kthread_work *work);  // ‰Ω†ÂÜôÁöÑÂ∑•‰ΩúÂáΩÊï∞
    atomic_t flushing;
    ...
};
```

Êèê‰∫§Áªô `kthread_worker` ÁöÑÊØè‰∏Ä‰∏™‰ªªÂä°Â∞±ÊòØ‰∏Ä‰∏™ `kthread_work` ÂØπË±°„ÄÇ

---

### Ê†∏ÂøÉÂáΩÊï∞ËØ¥Êòé

#### 1. `kthread_create_worker()`
```c
struct kthread_worker *kthread_create_worker(unsigned int flags, const char *namefmt, ...);
```
* ÂàõÂª∫Âπ∂ÂàùÂßãÂåñ‰∏Ä‰∏™ `kthread_worker`
* ÂÜÖÈÉ®Ë∞ÉÁî® `kthread_create(kthread_worker_fn, worker, namefmt)` ÂêØÂä®Á∫øÁ®ã
* ‰ºöËÆæÁΩÆÂ•Ω `worker->task` Â≠óÊÆµ
* **Ê†∏ÂøÉÁÇπ**ÔºöËøô‰∏™ÂáΩÊï∞ÊòØ `kthread_worker_fn()` ÂîØ‰∏ÄÁöÑÂêàÊ≥ï‰ΩøÁî®ÂÖ•Âè£

#### 2. `kthread_init_worker(struct kthread_worker *worker)`
* ÂàùÂßãÂåñ‰∏Ä‰∏™Â∑≤ÊúâÁöÑ worker ÁªìÊûÑ‰ΩìÔºå‰ΩÜ‰∏çÂêØÂä®Á∫øÁ®ã
* ÂΩìÂ∏åÊúõÊÉ≥Ëá™Â∑±ÊéßÂà∂Á∫øÁ®ãÁîüÂëΩÂë®ÊúüÊó∂‰ΩøÁî®

#### 3. `kthread_worker_fn(void *worker)`
* Á∫øÁ®ã‰∏ªÂáΩÊï∞Ôºà‰∏çË¶ÅËá™Â∑±Áî®ÔºÅÔºâ
* ‰∏çÊñ≠‰ªé `worker->work_list` ‰∏≠ÊãâÂèñ‰ªªÂä°ÊâßË°å
* ‰ºöË∞ÉÁî® `__kthread_run_work(worker, work)` Êù•ÊâßË°åÊØè‰∏™Â∑•‰ΩúÈ°π

#### 4. `kthread_init_work()` / `kthread_queue_work()`
```c
void kthread_init_work(struct kthread_work *work, void (*fn)(struct kthread_work *));
bool kthread_queue_work(struct kthread_worker *worker, struct kthread_work *work);
```
* ÂàùÂßãÂåñ‰∏Ä‰∏™ `work` ÂØπË±°ÔºåÊåáÂÆöÂáΩÊï∞
* Êèê‰∫§‰ªªÂä°Âà∞ÊåáÂÆö `worker` ÁöÑÈòüÂàó‰∏≠ÔºåËá™Âä®Âî§ÈÜíÁ∫øÁ®ã

#### 5. `kthread_flush_work(struct kthread_work *work)`
* Á≠âÂæÖËøô‰∏™ work Ë¢´ÊâßË°åÂÆå
* Á±ª‰ºº flush_work()ÔºåÁî®‰∫éÂêåÊ≠•

#### 6. `kthread_destroy_worker(struct kthread_worker *worker)`
* ÂÅúÊ≠¢Á∫øÁ®ãÂπ∂ÈáäÊîæ worker ËµÑÊ∫ê
* ÈáäÊîæËµÑÊ∫ê

#### 7. `kthread_should_stop()`
* Áî®‰∫éÁ∫øÁ®ã‰∏ªÂáΩÊï∞‰∏≠Âà§Êñ≠ÊòØÂê¶Ë¶ÅÈÄÄÂá∫
* Ëá™ÂÜôÁ∫øÁ®ã loop Êó∂‰ΩøÁî®

---

### ÁªìÊûÑÂõæÔºöÂêÑÁªÑ‰ª∂ÂÖ≥Á≥ª

#### kthread_create_worker Ëá™Âä®ÊñπÂºè
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      struct kthread_worker    ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ                          ‚îÇ
‚îÇ ‚îÇ spinlock_t lock          ‚îÇ  ‚îÇ                          ‚îÇ
‚îÇ ‚îÇ struct list_head list    ‚îÇ  ‚îÇ                          ‚îÇ
‚îÇ ‚îÇ struct task_struct *task ‚îÇ  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ         ‚îÇ                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ                ‚îÇ
             ‚îÇ                            ‚îÇ                ‚îÇ
             ‚ñº                            ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     struct kthread_work    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   kthread_queue_work()   ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ ‚îÇ struct list_head node ‚îÇ  ‚îÇ                  ‚îÇ
‚îÇ ‚îÇ void (*func)(...)     ‚îÇ  ‚îÇ                  ‚ñº
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ kthread_worker_fn()   ‚îÇ
                                        ‚îÇ (Á∫øÁ®ã‰∏ªÂæ™ÁéØÂáΩÊï∞)      ‚îÇ
                                        ‚îÇ while (!stop) {       ‚îÇ
                                        ‚îÇ    get work from list ‚îÇ
                                        ‚îÇ    call work->func()  ‚îÇ
                                        ‚îÇ }                     ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### kthread_init_worker ÊâãÂä®ÊñπÂºè
```
ÊâãÂä®ÊñπÂºèÊï¥‰ΩìÁªìÊûÑÔºö

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               struct kthread_worker            ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ spinlock_t lock                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ struct list_head work_list                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ struct task_struct *task (Êú™Ëá™Âä®ËÆæÁΩÆ)      ‚îÇ ‚îÇ‚óÑ‚îÄ‚îÄ ‰Ω†Ëá™Â∑±ÂøÖÈ°ªÂêØÂä®Á∫øÁ®ãÔºåÂπ∂ÊâßË°å worker_fn
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚ñ≤
                        ‚îÇ
                        ‚îÇ   ‰ΩøÁî®Ôºö
                        ‚îÇ   kthread_init_worker(&worker);
                        ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ struct kthread_work (‰ªªÂä°È°π) ‚îÇ   ‚îÇ Á∫øÁ®ãÔºöÁî±‰Ω†Ë∞ÉÁî® kthread_run() ÂàõÂª∫ÁöÑ    ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ   ‚îÇ ÊâßË°åÂáΩÊï∞Ë∞ÉÁî® kthread_worker_fn()       ‚îÇ
‚îÇ ‚îÇ void (*func)(...)        ‚îÇ ‚îÇ   ‚îÇ ÂÆÉ‰ºö‰ªé worker->work_list ‰∏≠Êãâ‰ªªÂä°      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### ÊµÅÁ®ãÂõæÔºàÊó∂Â∫èÔºâ

#### kthread_create_worker Ëá™Âä®ÊñπÂºè
```
Ëá™ÂÆö‰πâÊ®°ÂùóÂàùÂßãÂåñÂáΩÊï∞
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ worker = kthread_create_worker(...);       ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ ÂÜÖÊ†∏ÂàõÂª∫Á∫øÁ®ãÂπ∂ËÆæÁΩÆ worker->task
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ kthread_init_work(&work, my_work_fn);      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ kthread_queue_work(worker, &work);           ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ Êää‰ªªÂä°ÊîæÂÖ• worker->work_list
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ÂÜÖÊ†∏Á∫øÁ®ãÂºÄÂßãËøêË°åÔºökthread_worker_fn(worker)    ‚îÇ
‚îÇ  --> while(1):                                 ‚îÇ
‚îÇ       - ‰ªé work_list ÂèñÂá∫‰ªªÂä°                  ‚îÇ
‚îÇ       - Ë∞ÉÁî® work->func(&work);                ‚îÇ
‚îÇ       - ÁªßÁª≠‰∏ã‰∏Ä‰∏™                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### kthread_init_worker ÊâãÂä®ÊñπÂºè
```
Ëá™ÂÆö‰πâÊ®°ÂùóÂàùÂßãÂåñÂáΩÊï∞
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ struct kthread_worker my_worker;    ‚îÇ
‚îÇ kthread_init_worker(&my_worker);    ‚îÇ ‚Üê ÂàùÂßãÂåñ‰ΩÜ‰∏çÂêØÂä®Á∫øÁ®ã
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ task = kthread_run(my_thread_fn, ...);‚îÇ ‚Üê ‰Ω†Ëá™Â∑±ÂàõÂª∫Á∫øÁ®ã
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ int my_thread_fn(void *arg)              ‚îÇ
‚îÇ { return kthread_worker_fn(&my_worker); }‚îÇ ‚Üê worker‰∏ªÂáΩÊï∞
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ kthread_worker_fn()                        ‚îÇ
‚îÇ - while (!kthread_should_stop()) {         ‚îÇ
‚îÇ     work = get from work_list              ‚îÇ
‚îÇ     call work->func()                      ‚îÇ
‚îÇ   }                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚ñ≤
      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ kthread_init_work(&work, my_work_fn);        ‚îÇ
‚îÇ kthread_queue_work(&my_worker, &work);       ‚îÇ ‚Üê Êèê‰∫§Â∑•‰Ωú‰ªªÂä°
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

#### Ëá™Âä®ÊñπÂºèÂíåÊâãÂä®ÊñπÂºèÂØπÊØî

| ÊØîËæÉÈ°π            | `kthread_create_worker()` Ëá™Âä®ÊñπÂºè | `kthread_init_worker()` ÊâãÂä®ÊñπÂºè |
| ----------------- | ---------------------------------- | -------------------------------- |
| worker ÂàÜÈÖç       | Ëá™Âä®ÂàÜÈÖçÂπ∂ÂàùÂßãÂåñ                   | Ëá™Â∑±ÂàÜÈÖçÊ†à‰∏äÊàñÂ†Ü‰∏ä               |
| Á∫øÁ®ãÂàõÂª∫          | ÂÜÖÈÉ®ÂàõÂª∫Âπ∂ÁªëÂÆö                     | Ëá™Â∑±Áî® `kthread_run()` ÂàõÂª∫      |
| ‰∏ªÂáΩÊï∞            | ÂÜÖÈÉ®ÁªëÂÆö `kthread_worker_fn()`     | ÊâãÂä®ÂÜôÁ∫øÁ®ãÂáΩÊï∞Ë∞ÉÁî®ÂÆÉ             |
| worker->task ËÆæÁΩÆ | Ëá™Âä®ËÆæÁΩÆ‰∏∫Á∫øÁ®ã                     | ÂøÖÈ°ªÊâãÂä®ËÆæÁΩÆÊàñÂøΩÁï•ÂÆÉ             |
| ÁÅµÊ¥ªÊÄß            | ÁÆÄÊ¥ÅÂ∞ÅË£Ö                           | Êõ¥ÁÅµÊ¥ªÂèØÊéßÔºà‰ºòÂÖàÁ∫ß„ÄÅÁªëÂÆö CPU Á≠âÔºâ|
| Êé®ËçêÁ®ãÂ∫¶          | ‚úÖ È´ò                              | ‚ö†Ô∏è ‰∏≠ÔºàÊúâÈúÄÊ±ÇÊó∂Ôºâ                 |

---

### ‰∏∫‰ªÄ‰πà **‰∏çËÉΩ** ÊâãÂä®Ë∞ÉÁî® `kthread_worker_fn`Ôºü

Âõ†‰∏∫ÂÆÉÊòØ**Á∫øÁ®ã‰∏ªÂæ™ÁéØÂáΩÊï∞**Ôºå‰∏çÊòØ‰Ω†‰∏öÂä°ÈÄªËæëÁöÑ‰∏ÄÈÉ®ÂàÜ„ÄÇ

#### ‰∏æ‰æãËØ¥ÊòéÔºö

ËøôÊ†∑ÂÜôÔºö
```c
task = kthread_run(kthread_worker_fn, worker, "my_kthread");
```

ÈóÆÈ¢òÊù•‰∫ÜÔºö
* `worker->task` ÊòØÁ©∫ÁöÑ
* `kthread_worker_fn` ËøõÊù•‰ºö `WARN_ON(worker->task != current)`
* Â¥©‰∫Ü ‚ùå

ËÄåÂÜÖÊ†∏ÂéüÂßãËÆæËÆ°ÊòØËøôÊ†∑ÁöÑÔºö
```c
worker = kthread_create_worker();
  -> Ë∞ÉÁî® kthread_create(kthread_worker_fn, worker, ...)
     -> ËÆæÁΩÆ worker->task = ÂàõÂª∫ÁöÑÁ∫øÁ®ã
```

ÁªïËøá `kthread_create_worker`ÔºåÂ∞±Á†¥Âùè‰∫ÜËøô‰∏™Êú∫Âà∂„ÄÇ

---

#### ÊúÄÂ∞èÂêàÊ≥ïÁî®Ê≥ïÁ§∫‰æã

```c
static struct kthread_worker *worker;
static struct kthread_work my_work;

void my_work_fn(struct kthread_work *work)
{
    pr_info("Running my work function!\n");
}

static int __init mymod_init(void)
{
    worker = kthread_create_worker(0, "my_worker_thread");
    if (IS_ERR(worker)) {
        pr_err("Failed to create worker thread\n");
        return PTR_ERR(worker);
    }

    kthread_init_work(&my_work, my_work_fn);
    kthread_queue_work(worker, &my_work);
    return 0;
}

static void __exit mymod_exit(void)
{
    kthread_destroy_worker(worker);
}
```

Âè™ÈúÄÁÆ°Ôºö
* ÂÆö‰πâÂ•Ω `work` Âíå `my_work_fn`
* Áî® `kthread_create_worker()` ÂàõÂª∫Á∫øÁ®ã
* Êèê‰∫§ `kthread_queue_work()` Âç≥ÂèØ


---

#### ÈîôËØØÂÅöÊ≥ï vs Ê≠£Á°ÆÂÅöÊ≥ïÂØπÊØî

| ÈîôËØØ‰ª£Á†Å                              | ÈóÆÈ¢ò                                                     |
| ------------------------------------- | -------------------------------------------------------- |
| `kthread_run(kthread_worker_fn, ...)` | **ÈîôËØØ**‰ΩøÁî®‰∫ÜÂÜÖÊ†∏Á∫øÁ®ãÁöÑ‰∏ªÂæ™ÁéØÂáΩÊï∞ÔºåÁªïËøá‰∫Ü worker ÂàùÂßãÂåñ |
| `worker->task == NULL`                | ‰ºöËß¶Âèë `WARN_ON()`ÔºåÁ∫øÁ®ãÊú™ÁªëÂÆöÂà∞ worker ‰∏ä               |

| Ê≠£Á°ÆÊñπÂºè                               | ËØ¥Êòé                               |
| -------------------------------------- | ---------------------------------- |
| `worker = kthread_create_worker(...);` | Ëá™Âä®ÂàõÂª∫Á∫øÁ®ãÔºåÁªëÂÆö `worker->task`  |
| Êèê‰∫§Â∑•‰ΩúÈ°π                             | Áî® `kthread_queue_work()` Ê≠£Â∏∏Ë∞ÉÂ∫¶ |

---

#### Áî® `kthread_run()` ÂàõÂª∫Á∫øÁ®ãÔºåËØ•ÊÄé‰πàÂÅöÔºü

Â∞±**Âà´Áî® `kthread_worker` Á≥ªÁªü**ÔºåÁõ¥Êé•Ëá™Â∑±ÂÜô‰∏™Á∫øÁ®ãÂáΩÊï∞Ôºö

```c
int my_thread_fn(void *arg)
{
    while (!kthread_should_stop()) {
        // do something
        msleep(1000);  // Ê®°ÊãüÂë®Êúü‰ªªÂä°
    }
    return 0;
}
```

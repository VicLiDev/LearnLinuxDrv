
## 忙等（Busy-wait）延迟

> 不会让出 CPU，CPU 空转等待，精度高，但浪费 CPU 资源。
> 常用于**短延迟（us 级别）**，比如硬件寄存器写后等待硬件状态变化。

| 函数        | 单位     | 精度  | 让出 CPU | 说明                                                |
| ----------- | -------- | ----- | -------- | --------------------------------------------------- |
| `mdelay(n)` | 毫秒(ms) | ~1ms  | ❌       | 内部是 `udelay` 乘 1000，不建议长时间用，会浪费 CPU |
| `udelay(n)` | 微秒(us) | ~1us  | ❌       | 纯忙等，适合 < 1ms 延迟                             |
| `ndelay(n)` | 纳秒(ns) | ~1ns  | ❌       | 精度很高，极短延迟（几十 ns\~几 us）                |

**例子：**

```c
udelay(10);   // 延迟 10 微秒
ndelay(500);  // 延迟 500 纳秒
mdelay(2);    // 延迟 2 毫秒（相当于 udelay(2000)）
```

---

## 可调度的短延迟（低精度睡眠）

> 会让出 CPU，让调度器去运行别的任务，适合**非实时**延迟。
> 精度不高（取决于系统调度周期 HZ 值）。

| 函数                       | 单位 | 精度       | 让出 CPU | 说明                                                 |
| -------------------------- | ---- | ---------- | -------- | ---------------------------------------------------- |
| `msleep(ms)`               | ms   | 10~20ms    | ✅       | 休眠至少 `ms` 毫秒，低精度，内核会切换任务           |
| `msleep_interruptible(ms)` | ms   | 同上       | ✅       | 可被信号打断（返回前检查信号）                       |
| `usleep_range(min, max)`   | us   | ~10us+     | ✅       | 让调度器在[min, max]微秒之间唤醒任务，更精确的短睡眠 |

**例子：**

```c
msleep(50); // 休眠 50ms（可能会多一些）
usleep_range(100, 200); // 休眠 100~200us
```

---

## 高精度定时延迟（HR Timer 支持）

> 在启用 `CONFIG_HIGH_RES_TIMERS` 时，延迟精度可以到 us 级。
> 适合需要较高精度但不忙等的情况。

| 函数                   | 单位  | 精度   | 让出 CPU | 说明                       |
| ---------------------- | ----- | ------ | -------- | -------------------------- |
| `hrtimer` API          | ns/us | 高精度 | ✅       | 高精度定时器，支持回调函数 |
| `schedule_hrtimeout()` | ns/us | 高精度 | ✅       | 高精度睡眠，直到 timeout   |

**例子（高精度睡眠 500us）：**

```c
ktime_t t = ktime_set(0, 500 * 1000); // 500us
schedule_hrtimeout(&t, HRTIMER_MODE_REL);
```

---

## 基于 jiffies 的延迟

> 粗粒度，受 **HZ**（系统时钟频率）限制，常用于长延迟。

| 函数                  | 单位    | 精度      | 让出 CPU | 说明                        |
| --------------------- | ------- | --------- | -------- | --------------------------- |
| `schedule_timeout(t)` | jiffies | 取决于 HZ | ✅       | 睡眠指定 jiffies（1/HZ 秒） |
| `ssleep(sec)`         | 秒      | 秒级      | ✅       | 直接睡眠 n 秒               |

**例子：**

```c
set_current_state(TASK_INTERRUPTIBLE);
schedule_timeout(msecs_to_jiffies(500)); // 500ms
```

---

## 延迟函数选用建议

| 延迟时间     | 是否允许让出 CPU | 推荐函数                                |
| ------------ | ---------------- | --------------------------------------- |
| < 1us        | ❌               | `ndelay()`                              |
| 1us ~ 1ms    | ❌               | `udelay()`                              |
| 1ms ~ 20ms   | ❌               | `mdelay()`（不推荐，改用 usleep_range） |
| 10us ~ 20ms  | ✅               | `usleep_range()`                        |
| > 20ms       | ✅               | `msleep()` 或 `schedule_timeout()`      |

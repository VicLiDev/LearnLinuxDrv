# All kinds bus

```
+-------+  User
|       |  virtual
| CPU:  |  addresses
| user  | ----------------+
| space |                 |
|       |                 |
+-------+                 |
                          |
                          |              +----------+
                          |              |          |
            Kernel        v              |          |
+--------+  virtual  +-------+ physical  |          | physical  +-------+ bus      +--------+
|        |  address  |       | address   | physical | address   |       | address  |        |
| CPU:   | --------> |  MMU  | --------> | memery   | --------> | IOMMU | -------> | Device |
| kernel |  Kernel   |       |           |          |           |       |          |        |
| space  |  logical  +-------+           |          |           +-------+          +--------+
|        |  address                      |          |
+--------+                               |          |
                                         +----------+
```

tips:
1. bus addr maybe equal to physical address, if don't have iommu
2. Kernel logical address maps a portion (perhaps all) of hardware memory,
   usually treated as a physical address. On most architectures,
   logical addresses differ from their associated physical addresses
   by only a fixed offset.
3. Low memory: memory at logical address in kernel space
   High memory: Memory with no logical address because it is outside
                the address range reserved for kernel virtual addresses




# Device memory mapping relationship

from https://docs.kernel.org/core-api/dma-api-howto.html


```
             CPU                  CPU                  Bus
           Virtual              Physical             Address
           Address              Address               Space
            Space                Space

          +-------+             +------+             +------+
          |       |             |MMIO  |   Offset    |      |
          |       |  Virtual    |Space |   applied   |      |
        C +-------+ --------> B +------+ ----------> +------+ A
          |       |  mapping    |      |   by host   |      |
+-----+   |       |             |      |   bridge    |      |   +--------+
|     |   |       |             +------+             |      |   |        |
| CPU |   |       |             | RAM  |             |      |   | Device |
|     |   |       |             |      |             |      |   |        |
+-----+   +-------+             +------+             +------+   +--------+
          |       |  Virtual    |Buffer|   Mapping   |      |
        X +-------+ --------> Y +------+ <---------- +------+ Z
          |       |  mapping    | RAM  |   by IOMMU
          |       |             |      |
          |       |             |      |
          +-------+             +------+
```

ioremap: C->B->A
- map kernal virtual address space to cpu pyh address space
- map pyh addr to bus addr space by host birdge
- read/write bus addr space by kernel virtual address

dma_alloc_coherent: X->Y, Z->Y
- map kernal virtual address space to cpu pyh address space
- map bus addr space to cpu pyh address space
- read/write pyh space by kernel virtual address
- config bus address to device, device read/write phy space by device bus address
